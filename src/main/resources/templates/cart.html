<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
</head>
<body>
<div th:replace="layout/fragments/header :: header"></div>
<div>
    <h1>장바구니</h1>
    <div class="card mb-3" style="max-width: 540px;" th:each="cart : ${userCarts}">
        <div class="row g-0">
            <div class="col-md-4">
                <img th:src="@{${cart.product.image}}" class="img-fluid rounded-start" alt="...">
            </div>
            <div class="col-md-7">
                <div class="card-body">
                    <h5 class="card-title"  th:text="${cart.product.name}">오늘하루도, 소심한 야옹이</h5>
                    <div th:text="${cart.product.writer} + '.' + ${cart.product.publisher}">조성윤.미디북스</div>
                    <p class="card-text" th:text="'Price: ' + ${cart.product.price} + '원'">20000원</p>
                </div>
                <div class="product-btn" data-price="20000">
                    <div class="btn-group">
                        <button type="submit" class="btn btn-outline-secondary decreaseBtn"
                                th:onclick="'updateCart(' + ${cart.id} + ', ' + ${cart.product.id} + ', ' + (${cart.quantity} - 1) + ')'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                 class="bi bi-file-minus" viewBox="0 0 16 16">
                                <path d="M5.5 8a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H6a.5.5 0 0 1-.5-.5"/>
                            </svg>
                            <span class="visually-hidden">Button</span>
                        </button>
                        <!--                        </form>-->
                        <div class="btn btn-outline-secondary">
                            <span class="quantity" th:text="${cart.quantity}" th:object="${cart}">0</span>
                        </div>
                        <!--                        <form th:action="@{/api/cart/update}" method="post" style="display:inline;">-->
                        <input type="hidden" name="cartItemId" th:value="${cart.id}"/>
                        <input type="hidden" name="productId" th:value="${cart.product.id}"/>
                        <input type="hidden" name="quantity" th:value="${cart.quantity + 1}"/>

                        <button type="submit" class="btn btn-outline-secondary increaseBtn"
                                th:onclick="'updateCart(' + ${cart.id} + ', ' + ${cart.product.id} + ', ' + (${cart.quantity} + 1) + ')'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                 class="bi bi-plus" viewBox="0 0 16 16">
                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                            </svg>
                            <span class="visually-hidden">Button</span>
                        </button>
                        <!--                        </form>-->
                    </div>
                    <div class="price" th:text="'총: ' + (${cart.quantity} * ${cart.product.price}) + '원'">0원</div>
                </div>
            </div>
            <button type="button" class="btn-close col-md-1" aria-label="Close"
                    th:onclick="'deleteCartItem(' + ${cart.id} + ')'"></button>
        </div>
    </div>
    <div id="total-price">총 액수: 00000원</div>
    <input class="btn btn-primary" type="submit" value="결제하기">
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 제품 요소를 가져옵니다.
        var products = document.querySelectorAll('.product-btn');

        products.forEach(function (product) {
            // 단가를 가져옵니다.
            var pricePerItem = parseFloat(product.getAttribute('data-price'));
            var quantityElement = product.querySelector('.quantity');
            var priceElement = product.querySelector('.price');
            var increaseBtn = product.querySelector('.increaseBtn');
            var decreaseBtn = product.querySelector('.decreaseBtn');
            const totalPriceElement = document.getElementById('total-price');

            // 수량과 가격을 업데이트하는 함수
            function updatePrice() {
                var quantity = parseInt(quantityElement.textContent);
                var totalPrice = pricePerItem * quantity;
                priceElement.textContent = "" + totalPrice.toFixed(0) + "원";
            }

            function updateTotalPrice() {
                let total = 0;
                const productButtons = document.querySelectorAll('.product-btn');
                productButtons.forEach(productBtn => {
                    const price = parseInt(productBtn.getAttribute('data-price'));
                    const quantity = parseInt(productBtn.querySelector('.quantity').textContent);
                    total += price * quantity;
                });
                totalPriceElement.textContent = `총 액수: ${total.toLocaleString()}원`;
            }

            // + 버튼을 클릭했을 때 수량을 증가시키는 함수
            increaseBtn.addEventListener('click', function () {
                var currentQuantity = parseInt(quantityElement.textContent);
                quantityElement.textContent = currentQuantity + 1;
                updatePrice();
                updateTotalPrice();
            });

            // - 버튼을 클릭했을 때 수량을 감소시키는 함수
            decreaseBtn.addEventListener('click', function () {
                var currentQuantity = parseInt(quantityElement.textContent);
                if (currentQuantity > 0) {
                    quantityElement.textContent = currentQuantity - 1;
                    updatePrice();
                    updateTotalPrice();
                }
            });
        });
    });


    function updateCart(cartItemId, productId, quantity) {
        fetch('/api/cart', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({cartItemId, productId, quantity})
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || '오류가 발생했습니다. 다시 시도해주세요.');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('성공:', data);
                alert("상품 개수가 변경되었습니다.");
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert("업데이트 에러: " + error.message);
                location.reload();
            });
    }

    function deleteCartItem(cartItemId) {
        fetch(`/api/cart?cartItemId=${cartItemId}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                console.log(data);
                location.reload();
            })
            .catch(error => console.error('Error:', error));
    }

</script>
</body>
</html>